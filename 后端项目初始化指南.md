# 后端项目初始化指南

## 项目结构

```
backend/
├── server.js                 # 服务器主入口文件
├── package.json              # 项目依赖配置
├── config/
│   └── database.js          # 数据库配置
├── middleware/
│   ├── logger.js            # 日志中间件
│   └── errorHandler.js      # 错误处理中间件
├── routes/
│   ├── users.js             # 用户路由
│   ├── habits.js            # 习惯路由
│   ├── checkIn.js           # 打卡路由
│   ├── notes.js             # 笔记路由
│   ├── statistics.js        # 统计路由
│   └── wechat.js            # 微信路由
└── controllers/
    ├── userController.js    # 用户控制器
    ├── habitController.js   # 习惯控制器
    ├── checkInController.js # 打卡控制器
    ├── noteController.js    # 笔记控制器
    ├── statisticsController.js # 统计控制器
    └── wechatController.js  # 微信控制器
```

## 部署步骤

### 1. 上传后端代码到服务器

将 `backend` 文件夹上传到服务器，例如：
```bash
# 在服务器上创建项目目录
mkdir -p /root/habit-diary/backend

# 使用SCP上传（在本地执行）
scp -r backend/* root@129.211.62.76:/root/habit-diary/backend/
```

### 2. 安装依赖

在服务器上执行：
```bash
cd /root/habit-diary/backend
npm install
```

### 3. 配置环境变量

确保 `.env` 文件已正确配置，包含以下内容：
```env
# 微信小程序配置
WECHAT_APP_ID=wx766b73af56ba849d
WECHAT_APP_SECRET=your_app_secret_here

# 服务器配置
SERVER_HOST=129.211.62.76
SERVER_PORT=3001
NODE_ENV=production

# 数据库配置
DB_HOST=gz-cdb-j5cb8gq5.sql.tencentcdb.com
DB_PORT=27393
DB_USER=root
DB_PASSWORD=qinghan741852963
DB_NAME=dakabiji
```

**重要：** 需要在微信公众平台获取 `WECHAT_APP_SECRET` 并更新到 `.env` 文件中。

### 4. 测试数据库连接

```bash
# 在服务器上执行
cd /root/habit-diary/backend
node -e "require('./config/database').testConnection()"
```

如果看到 "✅ 数据库连接成功"，说明数据库配置正确。

### 5. 启动服务器

#### 开发模式（带热重载）：
```bash
npm run dev
```

#### 生产模式：
```bash
npm start
```

### 6. 使用PM2管理进程（推荐）

安装PM2：
```bash
npm install -g pm2
```

启动服务：
```bash
cd /root/habit-diary/backend
pm2 start server.js --name habit-diary-backend
```

查看状态：
```bash
pm2 status
pm2 logs habit-diary-backend
```

设置开机自启：
```bash
pm2 startup
pm2 save
```

### 7. 验证服务运行

在浏览器或使用curl访问：
```bash
curl http://129.211.62.76:3001/health
```

应该返回：
```json
{
  "status": "ok",
  "message": "Habit Diary API is running",
  "timestamp": "2025-01-09T10:00:00.000Z"
}
```

## API接口列表

### 健康检查
- `GET /health` - 健康检查

### 用户接口
- `GET /api/users/info?openid=xxx` - 获取用户信息
- `PUT /api/users/info` - 更新用户信息
- `GET /api/users/overview?openid=xxx` - 获取用户统计概览

### 习惯接口
- `GET /api/habits?openid=xxx` - 获取习惯列表
- `POST /api/habits` - 创建习惯
- `GET /api/habits/:id?openid=xxx` - 获取习惯详情
- `PUT /api/habits/:id` - 更新习惯
- `DELETE /api/habits/:id?openid=xxx` - 删除习惯
- `GET /api/habits/:id/checkins?openid=xxx` - 获取习惯打卡记录

### 打卡接口
- `POST /api/checkin` - 创建打卡记录
- `GET /api/checkin?openid=xxx` - 获取打卡记录列表
- `GET /api/checkin/today?openid=xxx` - 获取今日打卡状态
- `DELETE /api/checkin/:id?openid=xxx` - 删除打卡记录
- `GET /api/checkin/statistics/:habitId?openid=xxx` - 获取打卡统计

### 笔记接口
- `GET /api/notes?openid=xxx` - 获取笔记列表
- `POST /api/notes` - 创建笔记
- `GET /api/notes/:id?openid=xxx` - 获取笔记详情
- `PUT /api/notes/:id` - 更新笔记
- `DELETE /api/notes/:id?openid=xxx` - 删除笔记
- `GET /api/notes/categories/list?openid=xxx` - 获取笔记分类
- `POST /api/notes/categories` - 创建笔记分类
- `DELETE /api/notes/categories/:id?openid=xxx` - 删除笔记分类

### 统计接口
- `GET /api/statistics/user/:userId` - 获取用户统计数据
- `GET /api/statistics/range?openid=xxx&start_date=xxx&end_date=xxx` - 获取日期范围统计数据
- `GET /api/statistics/habit/:habitId?openid=xxx` - 获取习惯统计数据
- `GET /api/statistics/monthly/:userId` - 获取月度统计

### 微信接口
- `POST /api/wechat/login` - 微信登录
- `GET /api/wechat/access_token` - 获取微信access_token

## 防火墙配置

确保服务器防火墙允许3000端口：
```bash
# 如果使用iptables
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT
sudo service iptables save

# 如果使用ufw
sudo ufw allow 3000
```

## 常见问题

### 1. 数据库连接失败
- 检查 `.env` 文件中的数据库配置是否正确
- 确认数据库服务器可访问
- 检查防火墙规则

### 2. 端口被占用
```bash
# 查看端口占用
netstat -tlnp | grep 3000

# 杀死占用进程
kill -9 <PID>
```

### 3. 依赖安装失败
```bash
# 清除缓存重新安装
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### 4. 微信登录失败
- 确认 `WECHAT_APP_ID` 和 `WECHAT_APP_SECRET` 正确
- 检查小程序是否已配置服务器域名白名单
- 确认code是否有效（5分钟内有效）

## Nginx反向代理配置

配置Nginx作为反向代理，将请求转发到后端服务：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # API接口代理
    location /api {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:3001;
    }
}
```

将上述配置保存到 `/etc/nginx/sites-available/habit-diary`，然后创建符号链接：

```bash
sudo ln -s /etc/nginx/sites-available/habit-diary /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 下一步

完成以上步骤后，后端服务应该已经正常运行。接下来需要：
1. 配置SSL证书（HTTPS）
2. 初始化前端小程序项目
