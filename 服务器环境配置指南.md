# 腾讯云服务器环境配置指南

## 一、服务器连接

### 1.1 使用SSH连接服务器
```bash
# 使用SSH密钥连接
ssh -i /path/to/your/key.pem root@your_server_ip

# 或使用密码连接
ssh root@your_server_ip
```

### 1.2 更新系统
```bash
# Ubuntu/Debian
apt update && apt upgrade -y

# CentOS/RHEL
yum update -y
```

---

## 二、安装Node.js

### 2.1 使用NVM安装Node.js（推荐）
```bash
# 安装NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载配置
source ~/.bashrc

# 安装Node.js LTS版本
nvm install --lts
nvm use --lts

# 验证安装
node -v
npm -v
```

### 2.2 直接安装Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
apt install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
yum install -y nodejs

# 验证安装
node -v
npm -v
```

---

## 三、安装MySQL

### 3.1 安装MySQL
```bash
# Ubuntu/Debian
apt install -y mysql-server mysql-client

# CentOS/RHEL
yum install -y mysql-server mysql
```

### 3.2 启动MySQL服务
```bash
# 启动MySQL
systemctl start mysql

# 设置开机自启
systemctl enable mysql

# 查看MySQL状态
systemctl status mysql
```

### 3.3 安全配置MySQL
```bash
# 运行安全配置脚本
mysql_secure_installation

# 按提示操作：
# 1. 设置root密码
# 2. 移除匿名用户
# 3. 禁止root远程登录
# 4. 移除测试数据库
# 5. 重新加载权限表
```

### 3.4 创建数据库和用户
```bash
# 登录MySQL
mysql -u root -p

# 在MySQL命令行中执行以下命令：
```

```sql
-- 创建数据库
CREATE DATABASE habit_diary CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建专用用户
CREATE USER 'habit_user'@'localhost' IDENTIFIED BY 'your_secure_password';

-- 授予权限
GRANT ALL PRIVILEGES ON habit_diary.* TO 'habit_user'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

---

## 四、安装PM2（进程管理）

### 4.1 安装PM2
```bash
npm install -g pm2

# 验证安装
pm2 -v
```

### 4.2 PM2常用命令
```bash
# 启动应用
pm2 start app.js --name habit-diary

# 查看状态
pm2 status

# 查看日志
pm2 logs habit-diary

# 重启应用
pm2 restart habit-diary

# 停止应用
pm2 stop habit-diary

# 删除应用
pm2 delete habit-diary

# 设置开机自启
pm2 startup
pm2 save
```

---

## 五、安装Nginx

### 5.1 安装Nginx
```bash
# Ubuntu/Debian
apt install -y nginx

# CentOS/RHEL
yum install -y nginx
```

### 5.2 启动Nginx
```bash
# 启动Nginx
systemctl start nginx

# 设置开机自启
systemctl enable nginx

# 查看Nginx状态
systemctl status nginx
```

### 5.3 配置防火墙
```bash
# Ubuntu (UFW)
ufw allow 'Nginx Full'
ufw allow ssh
ufw enable

# CentOS (firewalld)
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --permanent --add-service=ssh
firewall-cmd --reload
```

---

## 六、安装Git

### 6.1 安装Git
```bash
# Ubuntu/Debian
apt install -y git

# CentOS/RHEL
yum install -y git

# 验证安装
git --version
```

### 6.2 配置Git
```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

---

## 七、创建项目目录

```bash
# 创建项目根目录
mkdir -p /www/habit-diary

# 创建后端目录
mkdir -p /www/habit-diary/backend

# 创建前端目录
mkdir -p /www/habit-diary/frontend

# 设置权限
chown -R $USER:$USER /www/habit-diary
```

---

## 八、安装其他工具

### 8.1 安装构建工具
```bash
# Ubuntu/Debian
apt install -y build-essential

# CentOS/RHEL
yum groupinstall -y "Development Tools"
```

### 8.2 安装Python（如果需要）
```bash
# Ubuntu/Debian
apt install -y python3 python3-pip

# CentOS/RHEL
yum install -y python3 python3-pip
```

---

## 九、环境变量配置

### 9.1 创建环境变量文件
```bash
# 在后端目录创建.env文件
cd /www/habit-diary/backend
nano .env
```

### 9.2 环境变量内容
```env
# 微信小程序配置
APP_ID=wx766b73af56ba849d
APP_SECRET=your_app_secret_here

# 服务器配置
SERVER_HOST=0.0.0.0
SERVER_PORT=3000

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=habit_user
DB_PASSWORD=your_secure_password
DB_NAME=habit_diary

# 其他配置
NODE_ENV=production
```

---

## 十、验证安装

### 10.1 检查所有服务状态
```bash
# 检查Node.js
node -v
npm -v

# 检查MySQL
systemctl status mysql

# 检查Nginx
systemctl status nginx

# 检查PM2
pm2 -v

# 检查Git
git --version
```

### 10.2 测试MySQL连接
```bash
mysql -u habit_user -p habit_diary
```

---

## 十一、安全建议

### 11.1 更改SSH端口
```bash
# 编辑SSH配置
nano /etc/ssh/sshd_config

# 修改端口
Port 2222

# 重启SSH服务
systemctl restart sshd
```

### 11.2 配置防火墙
```bash
# 只允许必要的端口
ufw allow 2222/tcp  # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw enable
```

### 11.3 安装Fail2ban
```bash
apt install -y fail2ban
systemctl enable fail2ban
systemctl start fail2ban
```

---

## 十二、监控和日志

### 12.1 安装监控工具
```bash
# 安装htop
apt install -y htop

# 安装iotop
apt install -y iotop
```

### 12.2 配置日志轮转
```bash
# 创建日志目录
mkdir -p /var/log/habit-diary

# 配置日志轮转
nano /etc/logrotate.d/habit-diary
```

```
/var/log/habit-diary/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 restart habit-diary
    endscript
}
```

---

## 十三、备份策略

### 13.1 数据库备份脚本
```bash
# 创建备份目录
mkdir -p /backup/mysql

# 创建备份脚本
nano /usr/local/bin/backup-mysql.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="habit_diary"
DB_USER="habit_user"
DB_PASS="your_secure_password"

mkdir -p $BACKUP_DIR
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

```bash
# 设置执行权限
chmod +x /usr/local/bin/backup-mysql.sh

# 添加到crontab（每天凌晨2点备份）
crontab -e

# 添加以下行
0 2 * * * /usr/local/bin/backup-mysql.sh
```

---

## 十四、故障排查

### 14.1 查看系统日志
```bash
# 查看系统日志
journalctl -xe

# 查看Nginx日志
tail -f /var/log/nginx/error.log
tail -f /var/log/nginx/access.log

# 查看MySQL日志
tail -f /var/log/mysql/error.log
```

### 14.2 检查端口占用
```bash
# 查看端口占用
netstat -tlnp
# 或
ss -tlnp
```

### 14.3 检查磁盘空间
```bash
# 查看磁盘使用情况
df -h

# 查看目录大小
du -sh /www/habit-diary
```

---

## 十五、完成检查清单

- [ ] Node.js已安装并验证版本
- [ ] MySQL已安装并创建数据库
- [ ] PM2已安装并配置
- [ ] Nginx已安装并启动
- [ ] Git已安装并配置
- [ ] 项目目录已创建
- [ ] 环境变量文件已配置
- [ ] 防火墙已配置
- [ ] 备份脚本已设置
- [ ] 所有服务状态正常

---

**配置完成后，请告诉我，我将进行下一步操作。**
