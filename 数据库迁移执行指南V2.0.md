# 数据库迁移执行指南 V2.0

## 概述

本指南将帮助您执行习惯日记小程序V2.0的数据库迁移，添加打卡表功能模块和素材收集笔记功能模块相关表结构。

## 前置条件

1. 已安装MySQL 5.7+
2. 已创建基础数据库（执行过database_init.sql）
3. 已配置数据库连接信息

## 步骤一：配置环境变量

### 1. 创建.env文件

在项目根目录下创建`.env`文件，复制`.env.example`的内容并填写实际的数据库配置信息：

```bash
# 习惯日记小程序 - 项目配置文件

## 微信小程序配置
APP_ID=wx766b73af56ba849d
APP_SECRET=your_app_secret_here

## 服务器配置
SERVER_HOST=your_server_ip
SERVER_PORT=3000

## 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=habit_diary

## 其他配置
NODE_ENV=development
```

### 2. 配置说明

- **DB_HOST**: 数据库服务器地址（本地开发使用localhost）
- **DB_PORT**: 数据库端口（默认3306）
- **DB_USER**: 数据库用户名
- **DB_PASSWORD**: 数据库密码
- **DB_NAME**: 数据库名称（必须与database_init.sql中创建的数据库名一致）

## 步骤二：执行数据库迁移

### 方式一：使用MySQL命令行工具

1. 打开命令行终端
2. 登录MySQL：

```bash
mysql -u root -p
```

3. 选择数据库：

```sql
USE habit_diary;
```

4. 执行迁移脚本：

```sql
source d:/AI编程/dakabij/database_migration_v2.sql;
```

或者直接执行：

```bash
mysql -u root -p habit_diary < d:/AI编程/dakabij/database_migration_v2.sql
```

### 方式二：使用Node.js脚本执行

创建迁移执行脚本 `backend/scripts/migrate.js`：

```javascript
const fs = require('fs');
const path = require('path');
const mysql = require('mysql2/promise');
require('dotenv').config();

async function migrate() {
  try {
    console.log('开始执行数据库迁移...');

    const connection = await mysql.createConnection({
      host: process.env.DB_HOST,
      port: process.env.DB_PORT || 3306,
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_NAME,
      multipleStatements: true
    });

    console.log('数据库连接成功');

    const sqlPath = path.join(__dirname, '../../database_migration_v2.sql');
    const sql = fs.readFileSync(sqlPath, 'utf8');

    await connection.query(sql);
    console.log('✅ 数据库迁移执行成功');

    await connection.end();
  } catch (error) {
    console.error('❌ 数据库迁移失败:', error.message);
    process.exit(1);
  }
}

migrate();
```

执行迁移：

```bash
cd backend
node scripts/migrate.js
```

### 方式三：使用数据库管理工具

1. 打开Navicat、phpMyAdmin或其他数据库管理工具
2. 连接到habit_diary数据库
3. 打开SQL查询窗口
4. 复制`database_migration_v2.sql`的内容
5. 执行SQL脚本

## 步骤三：验证迁移结果

### 1. 检查新表是否创建成功

```sql
USE habit_diary;
SHOW TABLES;
```

应该能看到以下新表：
- task_categories（任务分类表）
- material_categories（素材分类表）
- materials（素材表）
- tags（标签表）
- social_platforms（社交平台表）
- content_publish（内容发布表）
- style_tests（风格测试表）
- fan_interactions（粉丝互动表）
- monetization_plans（变现方案表）
- theme_planning（主题规划表）

### 2. 检查表结构

```sql
DESC task_categories;
DESC material_categories;
DESC materials;
-- ... 其他表
```

### 3. 检查现有表的扩展字段

```sql
DESC habits;
DESC check_in_records;
DESC notes;
```

应该能看到新增的字段。

## 步骤四：插入初始数据

迁移脚本中已经包含了初始数据的插入语句，包括：

1. 默认任务分类
2. 默认素材分类
3. 默认标签

验证初始数据：

```sql
SELECT * FROM task_categories;
SELECT * FROM material_categories;
SELECT * FROM tags;
```

## 常见问题

### 问题1：外键约束错误

**错误信息**：`Cannot add foreign key constraint`

**解决方案**：
- 确保users表已存在
- 确保users表中有id字段
- 检查外键引用的字段类型是否一致

### 问题2：表已存在错误

**错误信息**：`Table 'xxx' already exists`

**解决方案**：
- 如果表已存在且不需要保留数据，先删除表：
  ```sql
  DROP TABLE IF EXISTS task_categories;
  ```
- 或者修改迁移脚本，使用`CREATE TABLE IF NOT EXISTS`

### 问题3：字段已存在错误

**错误信息**：`Duplicate column name 'xxx'`

**解决方案**：
- 检查是否已经执行过迁移
- 使用`SHOW COLUMNS FROM table_name`查看表结构
- 如果字段已存在，可以跳过对应的ALTER TABLE语句

### 问题4：字符集问题

**错误信息**：`Invalid character set`

**解决方案**：
- 确保数据库使用utf8mb4字符集
- 检查MySQL版本是否支持utf8mb4（需要5.5.3+）

## 回滚迁移

如果需要回滚迁移，可以执行以下SQL：

```sql
-- 删除新增的表
DROP TABLE IF EXISTS theme_planning;
DROP TABLE IF EXISTS monetization_plans;
DROP TABLE IF EXISTS fan_interactions;
DROP TABLE IF EXISTS style_tests;
DROP TABLE IF EXISTS content_publish;
DROP TABLE IF EXISTS social_platforms;
DROP TABLE IF EXISTS tags;
DROP TABLE IF EXISTS materials;
DROP TABLE IF EXISTS material_categories;
DROP TABLE IF EXISTS task_categories;

-- 恢复现有表的结构（删除新增字段）
ALTER TABLE notes DROP COLUMN note_type;
ALTER TABLE notes DROP COLUMN is_template;
ALTER TABLE notes DROP COLUMN template_id;

ALTER TABLE check_in_records DROP COLUMN completion_notes;
ALTER TABLE check_in_records DROP COLUMN satisfaction_score;
ALTER TABLE check_in_records DROP COLUMN time_spent;
ALTER TABLE check_in_records DROP COLUMN completion_time;

ALTER TABLE habits DROP COLUMN category_id;
ALTER TABLE habits DROP COLUMN target_value;
ALTER TABLE habits DROP COLUMN actual_value;
ALTER TABLE habits DROP COLUMN time_slot;
ALTER TABLE habits DROP COLUMN tags;
ALTER TABLE habits DROP COLUMN priority;
ALTER TABLE habits DROP COLUMN is_template;
ALTER TABLE habits DROP COLUMN template_id;
```

## 下一步

数据库迁移完成后，可以开始：

1. 开发后端API接口
2. 开发前端页面
3. 测试功能

参考文档：
- [详细开发计划V2.0.md](./详细开发计划V2.0.md)
- [前端页面设计文档.md](./前端页面设计文档.md)

## 技术支持

如果在执行迁移过程中遇到问题，请检查：

1. MySQL服务是否正常运行
2. 数据库连接信息是否正确
3. 用户是否有足够的权限
4. MySQL版本是否符合要求

如有其他问题，请参考项目README或联系开发团队。